I"ÃL<p>How to upload a file in Tomcat</p>

<h1 id="uploadfile-in-tomcat">UploadFile in Tomcat</h1>

<h2 id="1import-maven-dependencies">1.Import maven dependencies</h2>

<ul>
  <li>commons-io-2.6.jar</li>
  <li>commons-fileupload-1.4.jar</li>
</ul>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-fileupload/commons-fileupload --&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>commons-fileupload<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>commons-fileupload<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.4<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
<span class="c">&lt;!-- https://mvnrepository.com/artifact/commons-io/commons-io --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>commons-io<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>commons-io<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.6<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<h2 id="2jsp-files">2.jsp files</h2>

<h4 id="1-indexjsp--send-the-form-to-tomcat">(1) index.jsp : send the form to Tomcat</h4>

<ul>
  <li>form setting (Important)
    <ul>
      <li>method : <em>MUST</em> be post because get method has size limit(1024K)</li>
      <li>enctype: multipart/form-data â€“&gt; to mark the upload file(RFC1867)</li>
      <li>action : the servlet mapping of your UploadFileServlet</li>
    </ul>
  </li>
</ul>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"/TomcatTest/upload"</span> <span class="na">method=</span><span class="s">"post"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
    ç”¨æˆ·åç§°: <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;</span> <span class="nt">&lt;br&gt;</span>
    æ–‡ä»¶ä¸Šä¼ : <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">name=</span><span class="s">"filename"</span><span class="nt">&gt;</span>  <span class="nt">&lt;br&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"ä¸Šä¼ "</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<h4 id="2-messagejsp--show-the-message-of-receiving-file-successfully">(2) message.jsp : show the message of receiving file successfully</h4>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;h2&gt;</span>${message}<span class="nt">&lt;/h2&gt;</span>  
    // receive the message from request attribute
</code></pre></div></div>

<h2 id="3fileuploadservlet">3.FileUploadServlet</h2>

<ul>
  <li>Related classes
    <ul>
      <li><a href="http://commons.apache.org/proper/commons-fileupload/apidocs/org/apache/commons/fileupload/disk/DiskFileItemFactory.html">DiskFileItemFactory.java</a></li>
      <li><a href="http://commons.apache.org/proper/commons-fileupload/apidocs/org/apache/commons/fileupload/servlet/ServletFileUpload.html">ServletFileUpload.java</a></li>
    </ul>
  </li>
</ul>

<h4 id="steps">Steps</h4>

<ul>
  <li>(1) æ£€æµ‹è¯·æ±‚æŠ¥æ–‡æ˜¯å¦ä¸ºå¤šåª’ä½“ä¸Šä¼ </li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">if</span> <span class="o">(!</span><span class="nc">ServletFileUpload</span><span class="o">.</span><span class="na">isMultipartContent</span><span class="o">(</span><span class="n">req</span><span class="o">)){</span>
        <span class="c1">// å¦‚æœä¸æ˜¯ç›´æ¥ç»“æŸå¤„ç†</span>
        <span class="nc">PrintWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Error: è¡¨å•å¿…é¡»åŒ…å« enctype=multipart/form-data"</span><span class="o">);</span>
        <span class="n">writer</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
        <span class="k">return</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>(2) å·¥å‚åˆ›å»ºfileitemæ¥å®¹çº³ä¸Šä¼ çš„æ–‡ä»¶</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// å·¥å‚è®¾ç½®fileitemçš„å‚æ•°ï¼Œfileitemåªæ˜¯ç”¨æ¥å®¹çº³çš„ï¼Œä¼ è¾“äº¤ç»™ServletFileUpload</span>
    <span class="nc">DiskFileItemFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">DiskFileItemFactory</span><span class="o">();</span>

    <span class="c1">// å·¥å‚è®¾ç½®å‚æ•°</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setDefaultCharset</span><span class="o">(</span><span class="s">"utf-8"</span><span class="o">);</span>     <span class="c1">//è®¾ç½®ç¼–ç æ–¹å¼</span>
    <span class="c1">// åˆ›å»ºä¸´æ—¶æ–‡ä»¶åˆ é™¤å¤„ç†å™¨</span>
    <span class="nc">FileCleaningTracker</span> <span class="n">tracker</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileCleaningTracker</span><span class="o">();</span>
    <span class="n">tracker</span><span class="o">.</span><span class="na">track</span><span class="o">(</span><span class="n">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">),</span> <span class="k">new</span> <span class="nc">Object</span><span class="o">());</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setFileCleaningTracker</span><span class="o">(</span><span class="n">tracker</span><span class="o">);</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">factory</span><span class="o">.</span><span class="na">getFileCleaningTracker</span><span class="o">()</span> <span class="o">==</span> <span class="kc">null</span><span class="o">);</span>
    <span class="c1">// è®¾ç½®å†…å­˜ä¸´ç•Œå€¼ï¼Œè¶…è¿‡è¿™ä¸ªå€¼å°±æ”¹åœ¨ç¡¬ç›˜ä¸´æ—¶ç›®å½•å‚¨å­˜</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setSizeThreshold</span><span class="o">(</span><span class="no">MEMORY_THRESHOLD</span><span class="o">);</span>
    <span class="c1">// è®¾ç½®ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç›®å½•, è¿™ä¸ªåœ°å€å¿…é¡»æ˜¯å®‰å…¨çš„(ç”¨æˆ·æ— æ³•é€šè¿‡urlè®¿é—®ï¼Œä¾‹å¦‚/WEBâ€”INF/ä¸‹)</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"TempFile in: "</span> <span class="o">+</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"java.io.tmpdir"</span><span class="o">));</span>
    <span class="n">factory</span><span class="o">.</span><span class="na">setRepository</span><span class="o">(</span><span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">(</span><span class="s">"java.io.tmpdir"</span><span class="o">)));</span>
</code></pre></div></div>

<ul>
  <li>(3) ä½¿ç”¨ServletFileUploadæ¥å¤„ç†ä¸Šä¼ è¿‡ç¨‹</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="c1">// ä½¿ç”¨ServletFileUploadæ¥å¤„ç†ä¸Šä¼ è¿‡ç¨‹</span>
    <span class="nc">ServletFileUpload</span> <span class="n">upload</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServletFileUpload</span><span class="o">(</span><span class="n">factory</span><span class="o">);</span>

    <span class="c1">// è®¾ç½®ä¸Šä¼ æ“ä½œå‚æ•°</span>
    <span class="c1">// è®¾ç½®æ–‡ä»¶æœ€å¤§å€¼</span>
    <span class="n">upload</span><span class="o">.</span><span class="na">setFileSizeMax</span><span class="o">(</span><span class="no">MAX_FILE_SIZE</span><span class="o">);</span>
    <span class="c1">// è®¾ç½®è¯·æ±‚çš„æœ€å¤§å€¼</span>
    <span class="n">upload</span><span class="o">.</span><span class="na">setSizeMax</span><span class="o">(</span><span class="no">MAX_REQUEST_SIZE</span><span class="o">);</span>
    <span class="c1">// è®¾ç½®å­—ç¬¦é›†</span>
    <span class="n">upload</span><span class="o">.</span><span class="na">setHeaderEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
    <span class="c1">// (å¯é€‰) æ·»åŠ ä¸Šä¼ è¿›ç¨‹ç›‘å¬å™¨</span>
    <span class="c1">// TODO: 2020/7/21 ä½¿ç”¨è¿›ç¨‹æ¡éœ€è¦å‰ç«¯çŸ¥è¯†ï¼Œä»¥åè¡¥ä¸Šï¼Œä½†è¿™ä¸ªå°±ç®—å®ç°äº†ç½‘é€Ÿå¿«çš„è¯å¾ˆéš¾çœ‹è§æ•ˆæœ</span>
    <span class="n">upload</span><span class="o">.</span><span class="na">setProgressListener</span><span class="o">(</span><span class="k">new</span> <span class="nc">ProgressListener</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// l : å·²ç»è¯»å…¥çš„å­—èŠ‚æ•°</span>
        <span class="c1">// l1: æ–‡ä»¶æ€»å­—èŠ‚æ•°</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="kt">long</span> <span class="n">l</span><span class="o">,</span> <span class="kt">long</span> <span class="n">l1</span><span class="o">,</span> <span class="kt">int</span> <span class="n">i</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"We are currently reading item "</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">l</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"So far, "</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="s">" bytes have been read."</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"So far, "</span> <span class="o">+</span> <span class="n">l</span> <span class="o">+</span> <span class="s">" of "</span> <span class="o">+</span> <span class="n">l1</span>
                                  <span class="o">+</span> <span class="s">" bytes have been read."</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">});</span>
</code></pre></div></div>

<ul>
  <li>(4) å‡†å¤‡å¥½ä¸´æ—¶è·¯å¾„æ¥å­˜å‚¨ä¸Šä¼ çš„æ–‡ä»¶</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è¿™ä¸ªè·¯å¾„ç›¸å¯¹å½“å‰åº”ç”¨çš„ç›®å½•</span>
    <span class="nc">String</span> <span class="n">uploadPath</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRealPath</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span> <span class="o">+</span>
            <span class="nc">File</span><span class="o">.</span><span class="na">separator</span> <span class="o">+</span> <span class="no">UPLOAD_DIRECTORY</span><span class="o">;</span>  <span class="c1">// æ·»åŠ åˆ†éš”ç¬¦ç¡®ä¿è·¯å¾„å®‰å…¨</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"å‚¨å­˜è·¯å¾„:"</span> <span class="o">+</span> <span class="n">uploadPath</span><span class="o">);</span>

    <span class="c1">// å¦‚æœç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º</span>
    <span class="nc">File</span> <span class="n">uploadDir</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">uploadPath</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">uploadDir</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">uploadDir</span><span class="o">.</span><span class="na">mkdir</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// ç”¨ServletFileUploadæŠŠè¯·æ±‚æ•°æ®åˆ—è¡¨æ”¾è¿›ä¸´æ—¶ç›®å½•</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">FileItem</span><span class="o">&gt;</span> <span class="n">fileitems</span> <span class="o">=</span> <span class="n">upload</span><span class="o">.</span><span class="na">parseRequest</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">fileitems</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">fileitems</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">for</span> <span class="o">(</span><span class="nc">FileItem</span> <span class="n">item</span> <span class="o">:</span> <span class="n">fileitems</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// å¤„ç†ä¸åœ¨è¡¨å•ä¸­çš„å­—æ®µ</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">item</span><span class="o">.</span><span class="na">isFormField</span><span class="o">())</span> <span class="o">{</span>
                    <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getName</span><span class="o">()).</span><span class="na">getName</span><span class="o">();</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">item</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
                    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileName</span><span class="o">);</span>
                    <span class="nc">String</span> <span class="n">filePath</span> <span class="o">=</span> <span class="n">uploadPath</span> <span class="o">+</span> <span class="nc">File</span><span class="o">.</span><span class="na">separator</span> <span class="o">+</span> <span class="n">fileName</span><span class="o">;</span>
                    <span class="nc">File</span> <span class="n">storeFile</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">File</span><span class="o">(</span><span class="n">filePath</span><span class="o">);</span>
                    <span class="n">item</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">storeFile</span><span class="o">);</span>
                    <span class="n">req</span><span class="o">.</span><span class="na">setAttribute</span><span class="o">(</span><span class="s">"message"</span><span class="o">,</span> <span class="s">"æ–‡ä»¶ä¸Šä¼ æˆåŠŸ!"</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>

    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">FileUploadException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="c1">// è·³è½¬åˆ° message.jsp</span>
    <span class="n">req</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">getRequestDispatcher</span><span class="o">(</span><span class="s">"/message.jsp"</span><span class="o">).</span><span class="na">forward</span><span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">resp</span><span class="o">);</span>
</code></pre></div></div>

<h2 id="webxml">web.xml</h2>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>uploadfile<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>com.HB.servlet.FileUploadServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>
    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>uploadfile<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/upload<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>
</code></pre></div></div>

<h2 id="åè®°">åè®°</h2>

<ul>
  <li>Use commons-fileupload to handle the transfer of files according to RFC-1867</li>
  <li>Use DiskFileItemFactory to store the data from fileupload and 
  package them into fileitems.</li>
  <li>But fileitems is also a temp repo. We need to write() to local directory</li>
</ul>

<h2 id="todo">TODO</h2>

<ul>
  <li>reading RFC-1867</li>
  <li>having added FileCleaningTracker but cannot see the result obviously</li>
  <li>implementing the Progress bar contact with uploadProgressListener in front page</li>
</ul>
:ET