---
layout: post
title:  "MySQL-03 DQL"
description: 
date:   2020-04-17
categories: MySQL
---
DQL (Data Query Language) Select

### 总公式

- Select语句的从句类似于过滤器（在前者的基础上匹配后者）

```sql
SELECT [ALL | DISTINCT]
{* | table.* | [table.field1[as alias1][,table.field2[as alias2]][,...]]}
FROM table_name [as table_alias]
  [left | right | inner join table_name2]  -- 联合查询
  [WHERE ...]  -- 指定结果需满足的条件
  [GROUP BY ...]  -- 指定结果按照哪几个字段来分组
  [HAVING]  -- 过滤分组的记录必须满足的次要条件
  [ORDER BY ...]  -- 指定查询记录按一个或多个条件排序
  [LIMIT {[offset,]row_count | row_countOFFSET offset}];
```

### 3.1 As

```sql
Select stu_no as `学号`, stu_name as `学生姓名` 
from students as `学生列表`
```

### 3.2 DISTINCT

```sql
Select Distinct studentno from result;
```

- Distinct 作用于所有列，不是部分作用于最靠近的列
- 如果有多个索引列，则检索所有列而不保证唯一性

### 3.2 排序和分页

```sql
Select emp_no, salary from salaries
order by salary
limit 0, 10;
```

- order by 可以用于非检索列，也可以多列排序
- DESC从大到小，它只作用于最近的列，多个排序每个都要加

### 3.3 组合Where子句  (AND \ OR \ IN \ NOT IN)

```sql
SELECT Studentno,StudentResult
FROM result
WHERE StudentResult >= 95 AND StudentResult <= 100;

-- 查询地址在北京,南京,河南洛阳的学生
SELECT studentno,studentname,address FROM student
WHERE address IN ('北京','南京','河南洛阳');
```

1. 短路问题：MySQL优先处理and，再处理or（解决：加括号）

```sql
## 不加括号的情况
select prod_name, prod_price from products
where vend_id = 1002 or (vend_id = 1003 and prod_price < 10);

## 加括号防止误判
select prod_name, prod_price from products
wherer (vend_id = 1002 or vend_id = 1003) and prod_price < 10;
```

2. In 的使用：直观；操作符少，容易管理；In比or快；__可以包含其他select语句__

3. NOT IN ： 表示除了，反集的思想

### 3.4 模糊查询 (where column_name like / regexp "xxx") 不推荐

- % --- 0个或者任意个ASCII字符
- _ --- 一个字符

```sql
-- 查询姓名中含有 嘉 字的
SELECT studentno,studentname FROM student
WHERE studentname LIKE '%嘉%';

-- 正则表达式
```

- Note : 将通配符放在范式最前面会放弃使用索引，导致检索速度变慢

### 3.5 函数

- 不同DBMS对SQL的支持不同，通常支持文本、数据、日期处理函数
- google them when using 
- 聚集函数 --> 减少DBMS数据回传的时间与空间开销
  - AVG()  忽略null
  - COUNT()  (*)计算所有行 (xxx)忽略null 
  - MAX()   日期、数值的最大值 文本排序后的最后一行 （忽略null）
  - MIN()   。。。。。。。。。。。。。。。。。
  - SUM()   忽略 null
- Note: 聚集函数忽略null； AVG和SUM可以与dintinct混用

### 3.6 数据分组 group by

1. 与聚集函数使用时，分组后再进行数据统计
2. group by 多个列 --> 嵌套 在最后一列进行数据统计
3. group by 后的列必须是检索列或有效的表达式（不能是聚集函数）
4. group by 后的表达式必须和select中的一样，不能用别名
5. 除了聚集函数语句，剩下select出现的列都必须在group by中出现
6. 分组的列中的NULL将作为单独分组列出

- 对分组进行过滤 having
- Note： 
  - where：在数据分组前过滤数据
  - having：在数据分组后过滤数据

### 3.5 联表查询 (join)

- 七种SQL Join 图

- 使用步骤
    - (1) 分析需求，确定数据来自哪几个表
    - (2) 确定使用哪种连接方式
    - (3) 确定交叉点

- 左外连接 left join  
       (左表全部返回,右表来一一匹配,若匹配不上,则返回左表的记录,并将右表记录以NULL填充)
- 右外连接 right join  
       (右表全部,左表来一一匹配,匹配不上的,则返回右表的记录,并将左表以NULL填充)

```sql
-- 思考题:查询参加了考试的同学信息(学号,学生姓名,科目名,分数)
SELECT s.studentno,studentname,subjectname,StudentResult
FROM student s
LEFT JOIN result r
ON r.studentno = s.studentno
RIGHT JOIN `subject` sub
ON sub.subjectno = r.subjectno
```

### 3.6 组合练习

```sql
-- 查询 数据库结构-1 的所有考试结果(学号 学生姓名 科目名称 成绩)
-- 按成绩降序排序
SELECT s.studentno,studentname,subjectname,StudentResult
FROM student s
INNER JOIN result r
ON r.studentno = s.studentno
INNER JOIN `subject` sub
ON r.subjectno = sub.subjectno
WHERE subjectname='数据库结构-1'
ORDER BY StudentResult DESC
LIMIT 0,5
```

## Note:

- in()中只能使用确定的值不能使用like中的替代符
- 引号使用
  - 定义表名和列名用反引号
  - 使用变量或常量时用双引号
- 没有值 != NULL != 值为0
- 